#!/bin/bash
# make sure you've ran create_toy_mc before
echo "This will take a while ... grab a coffee/tea/water"
mkdir -p logs
N_JOBS=4

i=0
k=3
options=("--offset_toy_mc=0 --offset_toy_data=0" "--offset_toy_mc=100 --offset_toy_data=0" "--offset_toy_mc=200 --offset_toy_data=0" "--offset_toy_mc=0 --offset_toy_data=100" "--offset_toy_mc=0 --offset_toy_data=200" "--offset_toy_mc=100 --offset_toy_data=100" "--offset_toy_mc=200 --offset_toy_data=200" "--offset_toy_mc=100 --offset_toy_data=200" "--offset_toy_mc=200 --offset_toy_data=100")


for var in MET HT ST WPT MT; do
echo "Doing unfolding pulls for: $var"
	case "$var" in
		MET)
			k=3
			;;
		HT)
			k=4
			;;
		ST)
			k=3
			;;
		MT)
			k=2
			;;
		WPT)
			k=3
			;;
		*)
			k=3
			;;
	esac
	echo 'Creating toy MC for all variables, 300x300, combined channel (default)'
	echo "Producing pull data for $var variable, combined channel, kv=$k"
	for j in 1 2 3 4 5 6 7 8 9; do
		echo "Doing part $j out of 9"
		nohup time python src/unfolding_tests/create_unfolding_pull_data.py -v $var -k $k -f data/toy_mc/toy_mc_${var}_N_300_7TeV.root -n 100 ${options[$j-1]} -c electron -s 7 &> logs/pull_${var}_kv${k}_${j}_7TeV.log &
		let i+=1
		nohup time python src/unfolding_tests/create_unfolding_pull_data.py -v $var -k $k -f data/toy_mc/toy_mc_${var}_N_300_8TeV.root -n 100 ${options[$j-1]} -c electron -s 8 &> logs/pull_${var}_kv${k}_${j}_8TeV.log &
		let i+=1
		if (( $i % N_JOBS == 0 ))
		then
			echo "Waiting on the above to finish."
    		wait;
		fi
	done
	nohup time python src/unfolding_tests/make_unfolding_pull_plots.py -i data/pull_data/7TeV/$var/100_input_toy_mc/k_value_$k -c electron -v $var -k $k -s 7 &> logs/pull_${var}_kv${k}_plots_7TeV.log &
	nohup time python src/unfolding_tests/make_unfolding_pull_plots.py -i data/pull_data/7TeV/$var/100_input_toy_mc/k_value_$k -c muon -v $var -k $k -s 7 &> logs/pull_${var}_kv${k}_plots_7TeV.log &
	nohup time python src/unfolding_tests/make_unfolding_pull_plots.py -i data/pull_data/8TeV/$var/100_input_toy_mc/k_value_$k -c electron -v $var -k $k -s 8 &> logs/pull_${var}_kv${k}_plots_8TeV.log &
	nohup time python src/unfolding_tests/make_unfolding_pull_plots.py -i data/pull_data/8TeV/$var/100_input_toy_mc/k_value_$k -c muon -v $var -k $k -s 8 &> logs/pull_${var}_kv${k}_plots_8TeV.log &
	wait
done
